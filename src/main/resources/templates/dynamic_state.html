<style>

    .glyphicon {
        /*height: 20px;*/
        /*width: 20px;*/
    }
</style>

<div class="panel panel-default" id="weixinqing_loading_front" style="width: 84%;float: right;display: none;">
    <div class="panel-body" align="center">
            <span class="glyphicon glyphicon-refresh" id="msg-loading-icon"
                  style="margin-left: 15px;font-size: 17px;margin-top: 6px;"
                  aria-hidden="true">
            </span>
        <span style="margin-left: 8px;margin-bottom: 10px;"
              id="content-loading-advice">微心情加载中，请您稍后...</span>
    </div>
</div>

<div id="addContentFlagFront" style="display: none;"></div>

<div id="weibosDiv">

    <#list vos as vo>
        <#if vo ? is_first>
            <input type="hidden" value="${vo.weibo.id ? c}" id="firstDataId">
            <input type="hidden" value="${vo.weibo.fTime ? datetime}" id="firstDataTime">
        </#if>

        <#if vo ? is_last>
            <input type="hidden" value="${vo.weibo.id ? c}" id="lastDataId">
            <input type="hidden" value="${vo.weibo.fTime ? datetime}" id="lastDataTime">
        </#if>

        <div class="panel panel-default weibo"
             style="width: 84%;height: auto;float: right;margin-left: 1%;">
            <div class="panel-body" style="margin-bottom: 0px;padding-bottom: 3px;">

                <div style="float: left;width: 13%;height: auto;">
                    <img src="/headimg/${vo.user.id ? c }" alt="..." class="img-circle weiboHeadImg"
                         style="width: 70px;height: 70px;">
                </div>

                <div style="float: right;width: 87%;margin: 0px;padding: 0px;">
                    <div style="float: left;width: 100%;">
                        <strong style="font-size: 15px;float: left;"
                                class="username">
                            ${vo.user.username}</strong>
                    </div>
                    <span style="color: #808080;float: left; margin-top: 5px;
        text-decoration: none;font-size: 12px;" class="datetime">${vo.weibo.fTime?datetime}</span>
                </div>

                <p style="display:block;width:87%;height:auto;margin-top: 5px;float: right;
                          overflow:hidden; text-overflow:ellipsis;" class="weibo_content">${vo.weibo.content}</p>

                <div style="width:87%;height:auto;margin-top: 5px;float: right;" class="weibo_imgs">
                    <#list vo.imgs as weiboImg>
                        <img src="/weixinqing/img/${weiboImg}"
                             alt="..."
                             style="height:140px;width:140px;margin:2px;margin-right: 0px;margin-left: 0px;"
                             class="img-rounded">
                    </#list>
                </div>
            </div>


            <style>
                ul li {
                    border: none;
                }

                * {
                    outline: none;
                }

                .op-ul li {
                    margin-top: 4px;
                }

                .op-ul li div:hover, .op-ul li div:focus {
                    cursor: pointer;
                }

                .btn.active.focus, .btn.active:focus, .btn.focus, .btn:active.focus, .btn:active:focus, .btn:focus {
                    outline: none;
                    outline-offset: 0;
                }

                .btn.active, .btn:active {
                    background-image: none;
                    outline: 0;
                    -webkit-box-shadow: none;
                }

                input[type="button"], input[type="submit"], input[type="reset"], input[type="file"]::-webkit-file-upload-button, button {
                    background: none;
                }

                popover {
                    z-index: 99999;
                }

                a, a:hover, a:visited, a:active {
                    text-decoration: none;
                }
            </style>
        <ul class="op-ul"
            style="float: left;width:100%;margin-bottom:0px;padding-bottom:0px;padding-left: 0px;">
            <li>
                <div style="text-align:center;" tabindex="1" class="save star user_action_advice"
                     weiboid="${vo.weibo.id ? c}">

                    <button tabindex="2"
                            class="btn starAdvice${vo.weibo.id ? c} "
                            data-placement="bottom"
                            data-toggle="popover"
                            data-container="body"
                            data-trigger="manual" data-html="true"
                            data-content="收藏成功！">
                        <#if vo.coll>
                            <span class="glyphicon glyphicon-star starspan${vo.weibo.id ? c}" aria-hidden="true"
                                  weiboid="${vo.weibo.id ? c}"></span>
                            <#else>
                                <span class="glyphicon glyphicon-star-empty starspan${vo.weibo.id ? c}"
                                      aria-hidden="true" weiboid="${vo.weibo.id ? c}"></span>
                        </#if>
                    </button>

                    <span class="">收藏</span>
                </div>
            </li>
            <li>
                <div style="text-align:center;" tabindex="7" class="share user_action_advice"
                     weiboid="${vo.weibo.id ? c}" uname="${vo.user.username}">

                    <input type="hidden" value='<div style="height: auto;width: 250px;padding-bottom:5px;">
                    <span style="font-family: Helvetica Neue,Helvetica,Arial,sans-serif;
    font-size: 14px;float:left;margin-bottom:5px;">转发${vo.user.username}的微心情</span>
    <a aria-hidden="true" class="trClose"  href="javascript:void(0)" onclick="trCloseA(${vo.weibo.id ? c})" weiboid="${vo.weibo.id ? c}" style="float:right;font-size: 18px;padding-top:0px;margin-top:-10px;cursor:pointer;
    color: #696e78; -webkit-font-smoothing: antialiased;font-family: wbficonregular !important;">&times;</a>
        <textarea cols="10" rows="4" id="trCommText${vo.weibo.id ? c}"
    style="resize:none;float: left;width: 250px;height: auto;border: 1px solid #eb7350;margin-bottom:5px;" maxlength="140" placeholder="请输入您想说的话"></textarea>
        <div style="float: left;margin-top:5px;margin-bottom:10px;">
        <input type="checkbox" id="hasComm${vo.weibo.id ? c}" aria-label="..." style="vertical-align:middle;float: left;height:14px;width:14px;">
        <span style="padding-top:2px;margin-left:3px;float: left;font: 12px/1.3 Arial,Microsoft YaHei;vertical-align:middle;"
        id="trCommUname">同时评论给 ${vo.user.username}</span>
        </div>

        <button  weiboid="${vo.weibo.id ? c}" style="z-index: 9999"
                            class="btn transSubmit${vo.weibo.id ? c}"
                            data-container="body" tabindex="3"
                            data-toggle="popover" data-placement="bottom"
                            data-trigger="manual" data-html="true"
                            data-content="">
                    <a class="submit-text transmitComm" weiboid="${vo.weibo.id ? c}" style="height:27px;width:65px;float: right;text-align:center;margin-bottom:7px;"
        ><span style="margin-top:1px;">转发</span></a>

                    </button>


        </div>'
                           id="trContent${vo.weibo.id ? c}">


                    <button weiboid="${vo.weibo.id ? c}" style="z-index: 9999"
                            class="btn trAdvice${vo.weibo.id ? c}"
                            data-container="body" tabindex="3"
                            data-toggle="popover" data-placement="bottom"
                            data-trigger="manual" data-html="true"
                            data-content=''>
                        <span class="glyphicon glyphicon-share transmit" aria-hidden="true"
                              weiboid="${vo.weibo.id ? c}"></span>
                    </button>

                    <span class="">${vo.trs ? c}</span>
                </div>
            </li>
            <li>
                <div style="text-align:center;" class="comm" weiboid="${vo.weibo.id ? c}">

                    <button tabindex="4"
                            class="btn commAdvice${vo.weibo.id ? c} "
                            data-placement="bottom"
                            data-trigger="manual"
                            data-container="body"
                            data-content="">
                        <span class="glyphicon glyphicon-comment" aria-hidden="true" weiboid="${vo.weibo.id ? c}"
                        ></span>
                    </button>

                    <span class="">${vo.comms ? c}</span>
                </div>
            </li>
            <li>
                <div style="text-align:center;" class="up" weiboid="${vo.weibo.id ? c}">

                    <button tabindex="5"
                            class="btn upAdvice${vo.weibo.id ? c} "
                            data-placement="bottom"
                            data-trigger="manual"
                            data-content="">

                        <#if vo.upd>
                            <span class="glyphicon glyphicon-thumbs-up" style="color: #eb7350;" aria-hidden="true"
                                  weiboid="${vo.weibo.id ? c}"/>
                            <#else>
                                <span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"
                                      weiboid="${vo.weibo.id ? c}"/>
                        </#if>
                    </button>


                    <span class="">${vo.ups ? c}</span>
                </div>
            </li>
        </ul>
        </div>
    </#list>
</div>



<div class="panel panel-default" id="weixinqing_loading_end"
     style="width: 84%;float: right;display: none;">
    <div class="panel-body" align="center">
            <span class="glyphicon glyphicon-refresh" id="msg-loading-icon"
                  style="margin-left: 15px;font-size: 17px;margin-top: 6px;"
                  aria-hidden="true">
            </span>
        <span style="margin-left: 8px;margin-bottom: 10px;"
              id="content-loading-advice">微心情加载中，请您稍后...</span>
    </div>
</div>


<script>

    function trCloseA(num) {
        $(".trAdvice" + num).popover("hide");
    }


    function uuid() {
        return (Math.floor(Math.random() * 1200000000)).toString(16) + "" + (Math.floor(Math.random() * 1200000000)).toString(16);
    }

    $('.trClose').click(function () {
        console.log('tr close');
        $(".trAdvice" + $(this).attr('weiboid')).popover("hide");
    });

    $('.transmitComm').click(function () {
        var weiboId = $(this).attr('weiboid');
        var content = "";
        if ($(".hasComm" + weiboId).is(':checked')) {
            content = $('.trCommText' + weiboId).val();
        }
        $.ajax({
            type: "post",
            url: "/user/transmit/" + weiboId,
            data: {
                "comment": content
            },
            success: function (data) {
                if (data.indexOf('登录') != -1) {
                    $('.transSubmit' + weiboId).attr('data-content', '请登录后再操作！');
                    $('.transSubmit' + weiboId).popover('show');
                    return;
                }

            },
            error: function () {

            }
        });
    });

    $('.user_action_advice').focusout(function () {
        var weiboId = $(this).attr('weiboid');

        $('.starAdvice' + weiboId).popover('hide');
        $('.transSubmit' + weiboId).popover('hide');

//        $('.trAdvice' + weiboId).popover('hide');
    });

    //    $('.share').click(function () {
    //        console.log('share');
    //        var weiboId = $(this).attr('weiboid');
    //        $.ajax({
    //            type: "post",
    //            url: '/user/transmit/' + weiboId,
    //            success: function (data) {
    //                if (data.indexOf('登录') != -1) {
    //                    $('.trAdvice' + weiboId).attr('data-content', '请登录后再操作！');
    //                    $('.trAdvice' + weiboId).popover('show');
    //                    return;
    //                }
    //                $('.trAdvice' + weiboId).attr('data-content', $('#trContent' + weiboId).val());
    //                $('.trAdvice' + weiboId).popover('show');
    //            },
    //            error: function () {
    //                $('.trAdvice' + weiboId).attr('data-content', '转发失败，请您稍后重试！');
    //                $('.trAdvice' + weiboId).popover('show');
    //            }
    //        })
    //    });

    $('.popover').focus(function () {
        console.log($(this));
    });

    $('.star').click(function () {

        var weiboId = $(this).attr('weiboid');
        $.ajax({
            type: "post",
            url: '/user/collection/' + weiboId,
            success: function (data) {
                if (data.indexOf('登录') != -1) {
                    $('.starAdvice' + weiboId).attr('data-content', '请登录后再操作！');
                    $('.starAdvice' + weiboId).popover('show');
                    return;
                }
                $(".starspan" + weiboId).toggleClass('glyphicon-star');
                $(".starspan" + weiboId).toggleClass('glyphicon-star-empty');
                $('.starAdvice' + weiboId).attr('data-content', '收藏成功！');
                $('.starAdvice' + weiboId).popover('show');
            },
            error: function () {
                $('.starAdvice' + weiboId).attr('data-content', '收藏失败，请您稍后重试！');
                $('.starAdvice' + weiboId).popover('show');
            }
        })
    });


</script>



<script>

    //    setTimeout(function(){
    //        window.scrollTo(0,0);
    //    }, 50);

    var isLoadingNews = false;
    function loading_news() {
        isLoadingNews = true;
        $.ajax({
            type: "post",
            url: '/index/news/' + $('#lastData').val(),
            success: function (data) {
                var weiboOrigin = $('.weibo')[0];
                var weiboDivObj = jQuery.extend(true, {}, weiboOrigin)
                var weiboDiv = $(weiboDivObj.outerHTML);

                console.log('weiboDiv=');
                console.log(weiboDiv);

                console.log('data=');
                console.log(data);

                var weibos = data.vo.weibos
                for (var i = 0; i < weibos.length; ++i) {
                    var weibo_i_vo = weibos[i];
                    console.log('weibo_i_vo=', typeof weibo_i_vo);
                    console.log(weibo_i_vo);
                    var weibo_i = weibo_i_vo.vo;
                    console.log('weibo_i=');
                    console.log(weibo_i);
                    weiboDiv.find('.weiboHeadImg').attr('src', '/headimg/' + weibo_i.user.id);
                    weiboDiv.find('.username').html(weibo_i.user.username);
                    weiboDiv.find('.datetime').html(new Date(weibo_i.weibo.fTime).pattern("yyyy-MM-dd hh:mm:ss"));
                    weiboDiv.find('.weibo_content').html(weibo_i.weibo.content)

                    var imgs = weibo_i.imgs;

                    imgsHtml = '';
                    for (var j = 0; j < imgs.length; ++j) {
                        var addImg = '<img src="/weixinqing/img/' + imgs[j] + '" ' +
                            'style="height:140px;width:140px;margin:2px;margin-right: 0px;margin-left: 0px;" ' +
                            'class="img-rounded">';
                        console.log('add_img=');
                        console.log(addImg);
                        imgsHtml = imgsHtml + addImg;
                    }
                    weiboDiv.find('.weibo_imgs').html(imgsHtml);
                    console.log('add_weiboDiv');
                    console.log('weiboDiv=');
                    console.log(weiboDiv);
                    console.log(weiboDiv[0].outerHTML);
                    $(weiboDiv[0].outerHTML).insertBefore('#addContentFlagEnd');
                }
                console.log('loading_news finish');
                isLoadingNews = false;
                $('#weixinqing_loading_end').hide();
            },
            error: function () {
                $('#content-loading-advice').text('微心情加载失败，请检查您的网络！');
                isLoadingNews = false;
            }
        });
    }

    var scrollFlag = 0;


    $(window).scroll(function () {

        var scrollTop = $(this).scrollTop();
        var scrollHeight = $(document).height();
        var windowHeight = $(this).height();
//        var offsetHeight = $('')
//       console.log(scrollTop + ' ' + windowHeight + ' ' + scrollHeight)

        if (scrollTop + windowHeight + 100 >= scrollHeight && scrollFlag > 1) {
//           alert('last')
            $('#weixinqing_loading_end').show();
            if (!isLoadingNews) {
                loading_news();

            }
        }

        ++scrollFlag;
        if (scrollFlag >= 200000) {
            scrollFlag = 1000;
        }

//        var scrollTop = document.documentElement.scrollTop || window.pageYOffset || document.body.scrollTop;
//        console.log(scrollTop);
//        if(document.documentElement.scrollHeight == document.documentElement.clientHeight + scrollTop ) {
//            $('weixinqing_loading').show();
//        }

    });

    //    $('document').ready(function () {
    ////        document.getElementsByTagName('body')[0].scrollTop = 0;
    //        setTimeout(function(){
    //            $(window).scrollTop(0);
    //        }, 1000)
    //    });
    document.onload = function () {
        setTimeout(function () {
            window.scrollTo(0, 0);
        }, 150);
    }

    //        $('html, body').animate({scrollTop:0}, 'slow');
    //        document.getElementsByTagName('body')[0].scrollTop = 0 + 'px';
    //    alert('drup');


    /** * 对Date的扩展，将 Date 转化为指定格式的String * 月(M)、日(d)、12小时(h)、24小时(H)、分(m)、秒(s)、周(E)、季度(q)
     可以用 1-2 个占位符 * 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字) * eg: * (new
     Date()).pattern("yyyy-MM-dd hh:mm:ss.S")==> 2006-07-02 08:09:04.423
     * (new Date()).pattern("yyyy-MM-dd E HH:mm:ss") ==> 2009-03-10 二 20:09:04
     * (new Date()).pattern("yyyy-MM-dd EE hh:mm:ss") ==> 2009-03-10 周二 08:09:04
     * (new Date()).pattern("yyyy-MM-dd EEE hh:mm:ss") ==> 2009-03-10 星期二 08:09:04
     * (new Date()).pattern("yyyy-M-d h:m:s.S") ==> 2006-7-2 8:9:4.18
     */
    Date.prototype.pattern = function (fmt) {
        var o = {
            "M+": this.getMonth() + 1, //月份
            "d+": this.getDate(), //日
            "h+": this.getHours() % 12 == 0 ? 12 : this.getHours() % 12, //小时
            "H+": this.getHours(), //小时
            "m+": this.getMinutes(), //分
            "s+": this.getSeconds(), //秒
            "q+": Math.floor((this.getMonth() + 3) / 3), //季度
            "S": this.getMilliseconds() //毫秒
        };
        var week = {
            "0": "/u65e5",
            "1": "/u4e00",
            "2": "/u4e8c",
            "3": "/u4e09",
            "4": "/u56db",
            "5": "/u4e94",
            "6": "/u516d"
        };
        if (/(y+)/.test(fmt)) {
            fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        }
        if (/(E+)/.test(fmt)) {
            fmt = fmt.replace(RegExp.$1, ((RegExp.$1.length > 1) ? (RegExp.$1.length > 2 ? "/u661f/u671f" : "/u5468") : "") + week[this.getDay() + ""]);
        }
        for (var k in o) {
            if (new RegExp("(" + k + ")").test(fmt)) {
                fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
            }
        }
        return fmt;
    }
</script>









